name: Test and Build Go-Trust

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    GO_VERSION: "1.23"

jobs:
    test-go-trust:
        name: Run Go-Trust Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout docker-go-trust repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    build-essential \
                    pkg-config \
                    libxml2-dev \
                    ca-certificates \
                    git

            - name: Clone go-trust source code
              run: |
                  git clone https://github.com/SUNET/go-trust.git /tmp/go-trust-source

            - name: Setup go-trust with controlled dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  # Create hybrid go.mod with our controlled dependencies
                  echo 'module github.com/SUNET/go-trust' > go.mod.new
                  echo '' >> go.mod.new
                  echo 'go ${{ env.GO_VERSION }}' >> go.mod.new
                  echo '' >> go.mod.new

                  # Copy require blocks from our controlled dependencies if they exist
                  if [ -f "${{ github.workspace }}/go.mod" ]; then
                    sed -n '/^require (/,/^)/{p}' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                    echo '' >> go.mod.new
                    # Copy replace directives
                    grep '^replace ' "${{ github.workspace }}/go.mod" >> go.mod.new || true
                  fi

                  # Apply the new go.mod
                  mv go.mod.new go.mod

                  # Use our controlled go.sum if it exists
                  if [ -f "${{ github.workspace }}/go.sum" ]; then
                    cp "${{ github.workspace }}/go.sum" ./
                  fi

            - name: Download dependencies
              working-directory: /tmp/go-trust-source
              run: |
                  go mod tidy
                  go mod download
                  go mod verify

            - name: Verify test setup
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Verifying go-trust project structure..."
                  ls -la
                  echo "Checking for test files..."
                  find . -name "*_test.go" -type f | head -10
                  echo "Checking go environment..."
                  go env
                  echo "Checking module status..."
                  go list -m all | head -10

            - name: Run go-trust tests
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Running all go-trust tests..."

                  # Run tests and capture both output and exit code
                  if go test -v ./...; then
                    echo "✅ All tests passed!"
                  else
                    TEST_EXIT_CODE=$?
                    echo "❌ Tests failed with exit code: $TEST_EXIT_CODE"
                    echo "Go version: $(go version)"
                    echo "Available packages:"
                    go list ./... || true
                    echo "Detailed test output:"
                    go test -v ./... || true
                    exit $TEST_EXIT_CODE
                  fi

            - name: Run tests package by package (diagnostic)
              working-directory: /tmp/go-trust-source
              if: failure()
              run: |
                  echo "Running tests package by package for diagnosis..."
                  for pkg in $(go list ./...); do
                    echo "Testing package: $pkg"
                    if ! go test -v "$pkg"; then
                      echo "❌ Failed package: $pkg"
                    else
                      echo "✅ Passed package: $pkg"
                    fi
                    echo "---"
                  done

            - name: Run go-trust tests with coverage
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Running go-trust tests with coverage..."

                  # Run coverage tests
                  if go test -v -coverprofile=coverage.out ./...; then
                    echo "Generating coverage reports..."
                    go tool cover -html=coverage.out -o coverage.html
                    echo "Coverage summary:"
                    go tool cover -func=coverage.out

                    # Extract coverage percentage
                    COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//' || echo "0")
                    echo "Total coverage: ${COVERAGE}%"

                    echo "✅ Coverage tests passed with ${COVERAGE}% coverage!"
                  else
                    echo "❌ Coverage tests failed"
                    exit 1
                  fi

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: /tmp/go-trust-source/coverage.*

            - name: Run go-trust tests with race detection
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Running go-trust tests with race detection..."
                  go test -race -v ./...

            - name: Build go-trust binary
              working-directory: /tmp/go-trust-source
              run: |
                  echo "Building go-trust binary..."
                  CGO_ENABLED=1 GOOS=linux go build -a \
                    -ldflags='-w -s -extldflags "-static"' \
                    -o go-trust ./cmd

                  echo "Verifying binary was created..."
                  ls -la go-trust
                  file go-trust

    build-docker:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: test-go-trust

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: |
                  docker build -t go-trust-service:test \
                    --build-arg GO_TRUST_VERSION=main \
                    -f Dockerfile .

            - name: Test Docker image
              run: |
                  echo "Testing Docker image can be created successfully..."
                  docker images go-trust-service:test

                  echo "Testing Docker image runs (quick validation)..."
                  # Run container in background to test it starts
                  docker run -d --name test-container \
                    -e SERVICE_PORT=6001 \
                    -e SERVICE_HOST=0.0.0.0 \
                    -e LOG_LEVEL=info \
                    -e CONFIG_FILE=/etc/go-trust/config.json \
                    -e PIPELINE_FILE=/app/pipeline.yaml \
                    -e FREQUENCY=3600 \
                    go-trust-service:test
                    
                  # Give it a moment to start
                  sleep 5

                  # Check if container is still running (not crashed immediately)
                  if docker ps | grep test-container; then
                    echo "✅ Container started successfully"
                  else
                    echo "❌ Container failed to start"
                    docker logs test-container
                    exit 1
                  fi

                  # Clean up
                  docker stop test-container
                  docker rm test-container

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: build-docker

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"

            - name: Upload Trivy scan results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v2
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"
